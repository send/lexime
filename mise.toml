[tasks.engine-lib]
description = "Build universal static library (x86_64 + aarch64)"
sources = ["engine/src/**/*.rs", "engine/crates/**/*.rs", "engine/Cargo.toml", "engine/Cargo.lock"]
outputs = ["build/liblex_engine.a"]
run = """
#!/usr/bin/env bash
set -euo pipefail
cd engine
cargo build --release --features trace --target x86_64-apple-darwin
cargo build --release --features trace --target aarch64-apple-darwin
cd ..
mkdir -p build
lipo -create \
  engine/target/x86_64-apple-darwin/release/liblex_engine.a \
  engine/target/aarch64-apple-darwin/release/liblex_engine.a \
  -output build/liblex_engine.a
"""

[tasks.uniffi-gen]
description = "Generate UniFFI Swift bindings from cdylib"
depends = ["engine-lib"]
sources = ["engine/src/api/**/*.rs", "engine/Cargo.toml"]
outputs = ["generated/lex_engine.swift", "generated/lex_engineFFI.h", "generated/lex_engineFFI.modulemap"]
run = """
#!/usr/bin/env bash
set -euo pipefail
cd engine
cargo build --release --features trace,uniffi-cli
cargo run --release --features uniffi-cli --bin uniffi-bindgen -- generate \
  --library target/release/liblex_engine.dylib \
  --language swift \
  --out-dir ../generated
cd ..
echo "Generated Swift bindings in generated/"
ls -la generated/
"""

[tasks.fetch-dict-mozc]
description = "Download Mozc dictionary data"
sources = ["engine/crates/lex-cli/src/bin/dictool.rs", "engine/crates/lex-cli/src/dict_source/mozc.rs"]
outputs = ["engine/data/mozc-raw/.stamp"]
run = "cd engine && cargo run -p lex-cli --bin dictool -- fetch --source mozc data/mozc-raw"

[tasks.dict-mozc]
description = "Compile binary dictionary from Mozc"
depends = ["fetch-dict-mozc"]
sources = ["engine/data/mozc-raw/.stamp", "engine/crates/lex-cli/src/bin/dictool.rs", "engine/crates/lex-cli/src/dict_source/mozc.rs"]
outputs = ["engine/data/lexime-mozc.dict"]
run = """
#!/usr/bin/env bash
set -euo pipefail
cd engine
cargo build --release -p lex-cli --bin dictool
target/release/dictool compile --source mozc data/mozc-raw data/lexime-mozc.dict
"""

[tasks.conn]
description = "Compile Mozc connection cost matrix"
depends = ["fetch-dict-mozc"]
sources = ["engine/data/mozc-raw/connection_single_column.txt", "engine/data/mozc-raw/id.def"]
outputs = ["engine/data/lexime.conn"]
run = """
#!/usr/bin/env bash
set -euo pipefail
cd engine
cargo build --release -p lex-cli --bin dictool
target/release/dictool compile-conn \
  --id-def data/mozc-raw/id.def \
  data/mozc-raw/connection_single_column.txt data/lexime.conn
"""

[tasks.dict]
description = "Build dictionary (Mozc only)"
depends = ["dict-mozc"]
outputs = ["engine/data/lexime.dict"]
run = """
#!/usr/bin/env bash
set -euo pipefail
cp engine/data/lexime-mozc.dict engine/data/lexime.dict
"""

[tasks.dict-clean]
description = "Remove compiled dictionaries (forces rebuild on next dict/build)"
run = """
#!/usr/bin/env bash
rm -f engine/data/lexime-mozc.dict engine/data/lexime.dict \
      engine/data/lexime.conn
echo "Removed compiled dictionaries"
"""

[tasks.build]
description = "Build Lexime.app (universal binary)"
depends = ["uniffi-gen", "dict", "conn"]
sources = [
  "Sources/*.swift",
  "generated/lex_engine.swift",
  "generated/lex_engineFFI.h",
  "generated/lex_engineFFI.modulemap",
  "build/liblex_engine.a",
  "engine/data/lexime.dict",
  "engine/data/lexime.conn",
  "Info.plist",
  "Resources/icon.tiff",
  "Resources/icon-roman.tiff",
  "Resources/en.lproj/InfoPlist.strings",
  "Resources/en.lproj/Localizable.strings",
  "Resources/ja.lproj/InfoPlist.strings",
  "Resources/ja.lproj/Localizable.strings",
]
outputs = ["build/Lexime.app/Contents/MacOS/Lexime"]
run = """
#!/usr/bin/env bash
set -euo pipefail
rm -f ~/Library/Logs/Lexime/lexime-trace.jsonl
APP=build/Lexime.app
MACOS=$APP/Contents/MacOS
RES=$APP/Contents/Resources
MACOS_MIN=13.0
SWIFTC_FLAGS="-O -Xcc -fmodule-map-file=generated/lex_engineFFI.modulemap"
LINK_FLAGS="-Lbuild -llex_engine"

mkdir -p "$MACOS" "$RES"
swiftc $SWIFTC_FLAGS $LINK_FLAGS -target x86_64-apple-macosx$MACOS_MIN \
  generated/lex_engine.swift Sources/*.swift -o "$MACOS/Lexime-x86_64"
swiftc $SWIFTC_FLAGS $LINK_FLAGS -target arm64-apple-macosx$MACOS_MIN \
  generated/lex_engine.swift Sources/*.swift -o "$MACOS/Lexime-arm64"
lipo -create "$MACOS/Lexime-x86_64" "$MACOS/Lexime-arm64" -output "$MACOS/Lexime"
rm "$MACOS/Lexime-x86_64" "$MACOS/Lexime-arm64"
cp Info.plist "$APP/Contents/Info.plist"
cp Resources/icon.tiff "$RES/icon.tiff"
cp Resources/icon-roman.tiff "$RES/icon-roman.tiff"
rm -rf "$RES/en.lproj" "$RES/ja.lproj"
cp -R Resources/en.lproj "$RES/en.lproj"
cp -R Resources/ja.lproj "$RES/ja.lproj"
cp engine/data/lexime.dict "$RES/"
cp engine/data/lexime.conn "$RES/"
codesign -f -s - "$APP"
echo "Build complete: $APP"
"""

[tasks.install]
description = "Install Lexime.app to ~/Library/Input Methods"
depends = ["build"]
run = """
#!/usr/bin/env bash
set -euo pipefail
INSTALL_DIR="$HOME/Library/Input Methods"
mkdir -p "$INSTALL_DIR"
rm -rf "$INSTALL_DIR/Lexime.app"
cp -R build/Lexime.app "$INSTALL_DIR/Lexime.app"
echo "Installed to $INSTALL_DIR/Lexime.app"
"""

[tasks.reload]
description = "Restart Lexime (macOS auto-restarts input methods)"
run = """
#!/usr/bin/env bash
pkill -x Lexime || true
echo "Sent kill signal to Lexime (macOS will auto-restart it)"
"""

[tasks.log]
description = "Stream Lexime log output"
run = """log stream --predicate 'process == "Lexime"' --style compact"""

[tasks.icon]
description = "Generate icon assets"
run = "bash scripts/icon.sh"

[tasks.test-swift]
description = "Run Swift unit tests (UniFFI round-trip)"
depends = ["uniffi-gen"]
# NOTE: Test files are listed explicitly because swiftc compiles all sources
# into one binary. If you add a new test file under Tests/, add it here too.
run = """
#!/usr/bin/env bash
set -euo pipefail
mkdir -p build
swiftc -Xcc -fmodule-map-file=generated/lex_engineFFI.modulemap \
  -Lbuild -llex_engine \
  generated/lex_engine.swift \
  Tests/TestRunner.swift Tests/TestRomajiFFI.swift Tests/TestDictFFI.swift Tests/TestSessionFFI.swift \
  -o build/test-runner && build/test-runner
"""


[tasks.explain]
description = "Explain conversion pipeline for a reading"
run = """
cd engine && cargo run --release -p lex-cli --bin lextool -- explain \
  data/lexime.dict "$@" --conn data/lexime.conn
"""

[tasks.snapshot]
description = "Generate conversion snapshot"
depends = ["dict", "conn"]
run = """
cd engine && cargo run --release -p lex-cli --bin lextool -- snapshot \
  data/lexime.dict data/lexime.conn \
  data/snapshot-readings.txt data/snapshot.jsonl -n 5
"""

[tasks.diff-snapshot]
description = "Compare current output against baseline snapshot"
depends = ["dict", "conn"]
run = """
cd engine && cargo run --release -p lex-cli --bin lextool -- diff-snapshot \
  data/lexime.dict data/lexime.conn \
  data/snapshot-readings.txt data/snapshot.jsonl -n 5
"""

[tasks.trace-log]
description = "Stream trace JSONL output"
run = "tail -f ~/Library/Logs/Lexime/lexime-trace.jsonl | python3 -m json.tool --no-ensure-ascii"

[tasks.fetch-model]
description = "Download Zenzai GGUF model"
run = """
#!/usr/bin/env bash
set -euo pipefail
mkdir -p data
if [ -f data/zenz-v3.1-Q5_K_M.gguf ]; then
  echo "Model already exists at data/zenz-v3.1-Q5_K_M.gguf"
  exit 0
fi
echo "Downloading zenz-v3.1-small-gguf (Q5_K_M, ~74MB)..."
curl -L -o data/zenz-v3.1-Q5_K_M.gguf \
  "https://huggingface.co/Miwa-Keita/zenz-v3.1-small-gguf/resolve/main/ggml-model-Q5_K_M.gguf"
echo "Downloaded to data/zenz-v3.1-Q5_K_M.gguf"
"""

[tasks.neural-score]
description = "Run neural scoring benchmark"
depends = ["fetch-model", "dict", "conn"]
run = """
cd engine && cargo run -p lex-cli --features neural --bin dictool -- neural-score \
  data/lexime.dict data/lexime.conn \
  --model ../data/zenz-v3.1-Q5_K_M.gguf \
  "$@"
"""

[tasks.romaji-export]
description = "Export default romaji mappings to ~/Library/Application Support/Lexime/romaji.toml"
run = """
dir="$HOME/Library/Application Support/Lexime"
mkdir -p "$dir"
cd engine && cargo run -p lex-cli --bin dictool -- romaji-export > "$dir/romaji.toml"
echo "Exported to $dir/romaji.toml"
"""

[tasks.settings-export]
description = "Export default settings to ~/Library/Application Support/Lexime/settings.toml"
run = """
dir="$HOME/Library/Application Support/Lexime"
mkdir -p "$dir"
cd engine && cargo run -p lex-cli --bin dictool -- settings-export > "$dir/settings.toml"
echo "Exported to $dir/settings.toml"
"""

[tasks.bench]
description = "Run criterion benchmarks"
run = "cd engine && cargo bench -p lex-core"

[tasks.lint]
description = "Run cargo fmt --check and clippy"
run = [
  "cd engine && cargo fmt --all --check",
  "cd engine && cargo clippy --workspace --all-features -- -D warnings",
]

[tasks.audit]
description = "Run cargo-audit (vulnerabilities) and cargo-machete (unused deps)"
run = [
  "cd engine && cargo audit",
  "cd engine && cargo machete",
]

[tasks.test]
description = "Run lint + workspace tests"
depends = ["lint"]
run = "cd engine && cargo test --workspace --all-features"

[tasks.clean]
description = "Remove build artifacts"
run = """
#!/usr/bin/env bash
rm -rf build
cd engine && cargo clean
echo "Clean complete"
"""
