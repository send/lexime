# Lexime 仕様書 (Draft v0.1)

## 概要

Lexime は macOS 向けの日本語予測入力システム。
PRIME にインスパイアされた予測変換型の入力体験を、軽量・高速に提供することを目指す。

## アーキテクチャ

```
┌─────────────────────────────────┐
│  macOS (InputMethodKit)         │
│  ┌───────────────────────────┐  │
│  │  Swift: IME Frontend      │  │
│  │  - IMKInputController     │  │
│  │  - 候補ウィンドウ (UI)     │  │
│  │  - ローマ字→かな変換       │  │
│  └─────────┬─────────────────┘  │
│            │ FFI (C ABI)         │
│  ┌─────────▼─────────────────┐  │
│  │  Rust: 変換エンジン        │  │
│  │  - 辞書検索               │  │
│  │  - 予測候補生成            │  │
│  │  - 学習・ランキング        │  │
│  └───────────────────────────┘  │
└─────────────────────────────────┘
```

### コンポーネント

- **Swift (IME Frontend)**: IMKInputController サブクラス、候補 UI、ローマ字→かな変換
- **Rust (変換エンジン)**: `liblex_engine` として staticlib ビルド、C ABI で Swift から呼び出し
- **FFI**: Rust を C ABI (`extern "C"`) で公開し、Swift 側で bridging header 経由で利用

## 入力モデル

- **予測変換型**: タイプ中にリアルタイムで候補を表示
- 変換キー不要が基本思想
- ローマ字入力 → かな → 漢字かな交じり文

## 開発フェーズ

### Phase 1 (MVP)

macOS で動作する最小限の IME。リスクの高い部分から順に検証する。

#### Step 1: スケルトン IME を macOS で動かす (Swift のみ)

最大のリスクポイント。InputMethodKit の設定がシビアなため、最初に検証する。

- Xcode プロジェクト作成（Input Method バンドル）
- `IMKInputController` サブクラスの最小実装
- `Info.plist` / entitlements の設定
- macOS にインストールして動作確認

ゴール: 任意のアプリでキー入力を受け取れる（素通し）

#### Step 2: ローマ字 → かな変換 (Swift)

- ローマ字テーブルの実装（`ka` → `か`、`shi` → `し` 等）
- 未確定文字列のインライン表示

ゴール: ローマ字を打つとひらがなが出る

#### Step 3: Rust プロジェクト + FFI ブリッジ構築

- Rust で `liblex_engine` を作成（staticlib）
- トリビアルな関数で Swift ↔ Rust の疎通確認
- Swift 側の bridging header 設定

ゴール: Swift から Rust の関数を呼べる

#### Step 4: 辞書データの選定と基本検索 (Rust)

- 辞書フォーマットの決定と読み込み
- かな文字列を受けて候補を返す API

ゴール: `かんじ` → `[漢字, 感じ, 幹事, ...]`

#### Step 5: 結合

- Step 2 のかな出力を Step 4 の辞書検索につなぐ
- 候補ウィンドウに表示し、確定できるようにする

ゴール: ローマ字を打って、変換候補が出て、確定できる

### Phase 2

予測入力の実現。

- 予測候補のリアルタイム表示
- ラティス（格子）構築 + 最適パス探索による変換精度向上
- 候補確定の操作体系設計

### Phase 3

学習機能。

- ユーザーの入力パターンに基づく候補ランキング調整
- 学習データのローカル保存 (`~/Library/Application Support/Lexime/`)

### Phase 4+

- 候補ランキングの継続改善
- ユーザー辞書
- 設定 UI
- その他

## 技術方針

- **辞書**: 未定（OSS 辞書の活用を検討）
- **学習データ**: ローカル保存
- **パフォーマンス**: 速度・軽量さを重視

## CI/CD

### 現状

- PR トリガーで `cargo fmt --check` / `cargo clippy` / `cargo test` を実行 (`.github/workflows/ci.yml`)

### TODO: リリースワークフロー (パブリック化後)

リポジトリをパブリック化した後、タグプッシュでリリースビルドを自動作成するワークフローを追加する。

- **トリガー**: `push: tags: ['v*']`
- **ランナー**: `macos-latest`（パブリックリポなら無料）
- **ビルド対象**: `liblex_engine` (staticlib, `aarch64-apple-darwin`)
- **成果物**: GitHub Release にバイナリをアップロード

## 未決事項

- 候補の確定操作体系（Tab? 数字キー? 自動確定?）
- 辞書データソースの選定
- 予測アルゴリズムの詳細（Phase 2 で設計）
- ラティス構築・探索手法の選定（Phase 2 で設計）
- 差別化の方向性（速度以外）
